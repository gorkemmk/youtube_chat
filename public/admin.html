<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strevio ‚Äî Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/common.css" />
  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-side {
      width: 250px; background: rgba(8, 8, 22, 0.95); border-right: 1px solid var(--border);
      padding: 24px 16px; flex-shrink: 0; display: flex; flex-direction: column; gap: 4px;
      backdrop-filter: blur(16px);
    }
    .admin-side .brand {
      font-family: var(--font-display); font-size: 18px; font-weight: 800;
      margin-bottom: 28px; padding: 0 8px;
    }
    .admin-side a {
      display: flex; align-items: center; gap: 10px;
      padding: 11px 14px; border-radius: var(--radius-sm); color: var(--text-secondary);
      font-size: 13px; font-weight: 500; text-decoration: none; transition: var(--transition);
      border-left: 3px solid transparent;
    }
    .admin-side a:hover { background: var(--bg-hover); color: var(--text-primary); }
    .admin-side a.active {
      background: rgba(var(--accent-rgb), 0.08); color: var(--accent-glow);
      border-left-color: var(--accent);
    }
    .admin-main { flex: 1; padding: 32px; overflow-y: auto; }
    .admin-main h2 {
      font-family: var(--font-display); font-size: 22px; font-weight: 800;
      margin-bottom: 24px;
    }

    .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-box {
      background: var(--bg-card); backdrop-filter: var(--glass-blur);
      border: 1px solid var(--border); border-radius: var(--radius);
      padding: 24px; text-align: center; transition: var(--transition);
      position: relative; overflow: hidden;
    }
    .stat-box::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--gradient); opacity: 0; transition: var(--transition);
    }
    .stat-box:hover { border-color: rgba(var(--accent-rgb), 0.2); transform: translateY(-2px); box-shadow: var(--shadow-neon); }
    .stat-box:hover::before { opacity: 1; }
    .stat-box .stat-value {
      font-family: var(--font-display); font-size: 28px; font-weight: 800;
      background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

    .admin-table {
      width: 100%; border-collapse: collapse; font-size: 13px;
      background: var(--bg-card); backdrop-filter: var(--glass-blur);
      border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); margin-bottom: 24px;
    }
    .admin-table th {
      background: rgba(var(--accent-rgb), 0.05); padding: 12px 14px;
      text-align: left; font-weight: 600; color: var(--text-muted);
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .admin-table td { padding: 10px 14px; border-top: 1px solid var(--border); color: var(--text-secondary); }
    .admin-table tr { transition: var(--transition); }
    .admin-table tr:hover { background: rgba(var(--accent-rgb), 0.03); }

    .badge-sm { font-size: 11px; padding: 3px 10px; border-radius: var(--radius-full); font-weight: 600; }
    .badge-active { background: rgba(16,185,129,0.1); color: var(--green); }
    .badge-inactive { background: rgba(239,68,68,0.1); color: var(--red); }
    .badge-admin { background: rgba(245,158,11,0.1); color: var(--yellow); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .act-log { max-height: 400px; overflow-y: auto; }
    .act-item {
      display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);
      font-size: 13px; transition: var(--transition);
    }
    .act-item:hover { background: var(--bg-hover); padding-left: 8px; }
    .act-time { color: var(--text-muted); white-space: nowrap; min-width: 140px; font-size: 12px; }
    .act-action { font-weight: 600; color: var(--accent-glow); }
    .act-detail { color: var(--text-muted); }

    @media (max-width: 768px) {
      .admin-layout { flex-direction: column; }
      .admin-side { width: 100%; flex-direction: row; overflow-x: auto; padding: 12px; align-items: center; gap: 2px; }
      .admin-side .brand { margin-bottom: 0; margin-right: 16px; white-space: nowrap; }
      .admin-side a { white-space: nowrap; }
      .admin-main { padding: 20px; }
    }
  </style>
</head>
<body>

<div class="admin-layout">
  <nav class="admin-side">
    <div class="brand text-gradient">‚ö° Strevio</div>
    <a href="#" class="active" onclick="showTab('dashboard')">üìä Dashboard</a>
    <a href="#" onclick="showTab('users')">üë• Users</a>
    <a href="#" onclick="showTab('pool')">üì° Chat Pool</a>
    <a href="#" onclick="showTab('activity')">üìù Log</a>
    <a href="/" style="margin-top:auto;color:var(--text-muted)">‚Üê Back to site</a>
  </nav>

  <main class="admin-main">
    <div class="tab-content active" id="tab-dashboard">
      <h2>Admin Dashboard</h2>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-value" id="sUsers">0</div><div class="stat-label">Users</div></div>
        <div class="stat-box"><div class="stat-value" id="sActive">0</div><div class="stat-label">Active Chats</div></div>
        <div class="stat-box"><div class="stat-value" id="sSessions">0</div><div class="stat-label">Sessions</div></div>
        <div class="stat-box"><div class="stat-value" id="sMessages">0</div><div class="stat-label">Total Messages</div></div>
        <div class="stat-box"><div class="stat-value" id="sSC">0</div><div class="stat-label">SuperChat</div></div>
        <div class="stat-box"><div class="stat-value" id="sMem">0</div><div class="stat-label">Memberships</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-users">
      <h2>Users</h2>
      <table class="admin-table">
        <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Plan</th><th>Channel</th><th>Status</th><th>Registered</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-pool">
      <h2>Chat Pool</h2>
      <table class="admin-table">
        <thead><tr><th>User</th><th>Video</th><th>Mode</th><th>Messages</th><th>Started</th><th>Status</th></tr></thead>
        <tbody id="poolBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-activity">
      <h2>Activity Log</h2>
      <div class="act-log" id="actLog"></div>
    </div>
  </main>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const token = localStorage.getItem('token');
if (!token) { window.location.href = '/login'; }
const hdrs = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

async function api(url, method = 'GET', body = null) {
  const opts = { method, headers: hdrs };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  return r.json();
}

function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function showTab(t) {
  document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.admin-side a').forEach(a => a.classList.remove('active'));
  document.getElementById('tab-' + t)?.classList.add('active');
  event.target?.classList.add('active');
  if (t === 'dashboard') loadDashboard();
  if (t === 'users') loadUsers();
  if (t === 'pool') loadPool();
  if (t === 'activity') loadActivity();
}

async function loadDashboard() {
  const d = await api('/admin/api/stats');
  if (!d.success) return;
  const s = d.data;
  document.getElementById('sUsers').textContent = s.userCount || 0;
  document.getElementById('sActive').textContent = s.activeChats || 0;
  document.getElementById('sSessions').textContent = s.totalConnections || 0;
  document.getElementById('sMessages').textContent = s.totalMessages || 0;
  document.getElementById('sSC').textContent = s.totalSuperChats || 0;
  document.getElementById('sMem').textContent = s.autoWatchCount || 0;
}

async function loadUsers() {
  const d = await api('/admin/api/users');
  if (!d.success) return;
  document.getElementById('usersBody').innerHTML = d.data.users.map(u => `<tr>
    <td>${u.id}</td>
    <td>${esc(u.username)}</td>
    <td>${esc(u.email)}</td>
    <td><span class="badge-sm">${u.plan}</span></td>
    <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${esc(u.youtube_channel||'-')}</td>
    <td><span class="badge-sm ${u.is_active?'badge-active':'badge-inactive'}">${u.is_active?'Active':'Inactive'}</span>
        ${u.is_admin?'<span class="badge-sm badge-admin">Admin</span>':''}
        ${u.is_banned?'<span class="badge-sm badge-inactive">Banned</span>':''}</td>
    <td style="font-size:.78rem">${new Date(u.created_at).toLocaleDateString()}</td>
    <td>
      <button class="btn btn-sm btn-outline" onclick="toggleBan(${u.id}, ${u.is_banned?0:1})">${u.is_banned?'Unban':'Ban'}</button>
      <button class="btn btn-sm btn-ghost" onclick="deleteUser(${u.id})" style="color:var(--red)">Delete</button>
    </td>
  </tr>`).join('');
}

async function toggleBan(id, ban) {
  await api(`/admin/api/users/${id}/ban`, 'PUT', { banned: !!ban });
  loadUsers();
}

async function deleteUser(id) {
  if (!confirm('This user will be deleted. Continue?')) return;
  await api(`/admin/api/users/${id}`, 'DELETE');
  loadUsers();
}

async function loadPool() {
  const d = await api('/admin/api/pool');
  if (!d.success) return;
  document.getElementById('poolBody').innerHTML = d.data.map(p => `<tr>
    <td>${esc(p.username||p.userId)}</td>
    <td>${esc(p.videoId||'-')}</td>
    <td><span class="badge-sm ${p.mode==='auto'?'badge-active':'badge-inactive'}">${p.mode||'?'}</span></td>
    <td>${p.totalMessages||0}</td>
    <td style="font-size:.78rem">${p.startedAt?new Date(p.startedAt).toLocaleString():'-'}</td>
    <td><span class="badge-sm ${p.isRunning?'badge-active':'badge-inactive'}">${p.isRunning?'Running':'Stopped'}</span></td>
  </tr>`).join('');
}

async function loadActivity() {
  const d = await api('/admin/api/activity');
  if (!d.success) return;
  document.getElementById('actLog').innerHTML = d.data.map(a => `<div class="act-item">
    <span class="act-time">${new Date(a.created_at).toLocaleString()}</span>
    <span class="act-action">${esc(a.action)}</span>
    <span class="act-detail">${esc(a.details||'')}</span>
  </div>`).join('');
}

loadDashboard();
</script>
</body>
</html>
