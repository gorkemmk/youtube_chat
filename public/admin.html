<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strevio ‚Äî Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/common.css" />
  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-side {
      width: 240px; background: var(--bg-card); border-right: 1px solid var(--border);
      padding: 1.5rem 1rem; flex-shrink: 0; display: flex; flex-direction: column; gap: .5rem;
    }
    .admin-side .brand { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; }
    .admin-side a {
      display: block; padding: .6rem 1rem; border-radius: 8px; color: var(--text-muted);
      font-size: .88rem; text-decoration: none; transition: .2s;
    }
    .admin-side a:hover, .admin-side a.active { background: rgba(108,99,255,.12); color: var(--accent); }
    .admin-main { flex: 1; padding: 2rem; overflow-y: auto; }
    .admin-main h2 { font-size: 1.3rem; margin-bottom: 1.2rem; }

    .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-box {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
      padding: 1.2rem; text-align: center;
    }
    .stat-box .stat-value { font-size: 1.8rem; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-box .stat-label { font-size: .78rem; color: var(--text-muted); margin-top: .2rem; }

    .admin-table { width: 100%; border-collapse: collapse; font-size: .85rem; background: var(--bg-card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 2rem; }
    .admin-table th { background: rgba(108,99,255,.08); padding: .7rem .8rem; text-align: left; font-weight: 600; color: var(--text-muted); font-size: .75rem; text-transform: uppercase; letter-spacing: .5px; }
    .admin-table td { padding: .65rem .8rem; border-top: 1px solid var(--border); }

    .badge-sm { font-size: .72rem; padding: 2px 8px; border-radius: 40px; font-weight: 600; }
    .badge-active { background: rgba(0,214,143,.12); color: #00D68F; }
    .badge-inactive { background: rgba(255,107,107,.12); color: #FF6B6B; }
    .badge-admin { background: rgba(255,217,61,.12); color: #FFD93D; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .act-log { max-height: 400px; overflow-y: auto; }
    .act-item {
      display: flex; gap: .8rem; padding: .6rem 0; border-bottom: 1px solid var(--border);
      font-size: .82rem;
    }
    .act-time { color: var(--text-muted); white-space: nowrap; min-width: 130px; }
    .act-action { font-weight: 500; }
    .act-detail { color: var(--text-muted); }

    @media (max-width: 768px) {
      .admin-layout { flex-direction: column; }
      .admin-side { width: 100%; flex-direction: row; overflow-x: auto; padding: .8rem; align-items: center; }
      .admin-side .brand { margin-bottom: 0; margin-right: 1rem; }
    }
  </style>
</head>
<body>

<div class="admin-layout">
  <nav class="admin-side">
    <div class="brand text-gradient">‚ö° Strevio</div>
    <a href="#" class="active" onclick="showTab('dashboard')">üìä Dashboard</a>
    <a href="#" onclick="showTab('users')">üë• Users</a>
    <a href="#" onclick="showTab('pool')">üì° Chat Pool</a>
    <a href="#" onclick="showTab('activity')">üìù Log</a>
    <a href="/" style="margin-top:auto;color:var(--text-muted)">‚Üê Back to site</a>
  </nav>

  <main class="admin-main">
    <div class="tab-content active" id="tab-dashboard">
      <h2>Admin Dashboard</h2>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-value" id="sUsers">0</div><div class="stat-label">Users</div></div>
        <div class="stat-box"><div class="stat-value" id="sActive">0</div><div class="stat-label">Active Chats</div></div>
        <div class="stat-box"><div class="stat-value" id="sSessions">0</div><div class="stat-label">Sessions</div></div>
        <div class="stat-box"><div class="stat-value" id="sMessages">0</div><div class="stat-label">Total Messages</div></div>
        <div class="stat-box"><div class="stat-value" id="sSC">0</div><div class="stat-label">SuperChat</div></div>
        <div class="stat-box"><div class="stat-value" id="sMem">0</div><div class="stat-label">Memberships</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-users">
      <h2>Users</h2>
      <table class="admin-table">
        <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Plan</th><th>Channel</th><th>Status</th><th>Registered</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-pool">
      <h2>Chat Pool</h2>
      <table class="admin-table">
        <thead><tr><th>User</th><th>Video</th><th>Mode</th><th>Messages</th><th>Started</th><th>Status</th></tr></thead>
        <tbody id="poolBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-activity">
      <h2>Activity Log</h2>
      <div class="act-log" id="actLog"></div>
    </div>
  </main>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const token = localStorage.getItem('token');
if (!token) { window.location.href = '/login'; }
const hdrs = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

async function api(url, method = 'GET', body = null) {
  const opts = { method, headers: hdrs };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  return r.json();
}

function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function showTab(t) {
  document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.admin-side a').forEach(a => a.classList.remove('active'));
  document.getElementById('tab-' + t)?.classList.add('active');
  event.target?.classList.add('active');
  if (t === 'dashboard') loadDashboard();
  if (t === 'users') loadUsers();
  if (t === 'pool') loadPool();
  if (t === 'activity') loadActivity();
}

async function loadDashboard() {
  const d = await api('/admin/api/stats');
  if (!d.success) return;
  const s = d.data;
  document.getElementById('sUsers').textContent = s.userCount || 0;
  document.getElementById('sActive').textContent = s.activeChats || 0;
  document.getElementById('sSessions').textContent = s.totalConnections || 0;
  document.getElementById('sMessages').textContent = s.totalMessages || 0;
  document.getElementById('sSC').textContent = s.totalSuperChats || 0;
  document.getElementById('sMem').textContent = s.autoWatchCount || 0;
}

async function loadUsers() {
  const d = await api('/admin/api/users');
  if (!d.success) return;
  document.getElementById('usersBody').innerHTML = d.data.users.map(u => `<tr>
    <td>${u.id}</td>
    <td>${esc(u.username)}</td>
    <td>${esc(u.email)}</td>
    <td><span class="badge-sm">${u.plan}</span></td>
    <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${esc(u.youtube_channel||'-')}</td>
    <td><span class="badge-sm ${u.is_active?'badge-active':'badge-inactive'}">${u.is_active?'Active':'Inactive'}</span>
        ${u.is_admin?'<span class="badge-sm badge-admin">Admin</span>':''}
        ${u.is_banned?'<span class="badge-sm badge-inactive">Banned</span>':''}</td>
    <td style="font-size:.78rem">${new Date(u.created_at).toLocaleDateString()}</td>
    <td>
      <button class="btn btn-sm btn-outline" onclick="toggleBan(${u.id}, ${u.is_banned?0:1})">${u.is_banned?'Unban':'Ban'}</button>
      <button class="btn btn-sm btn-ghost" onclick="deleteUser(${u.id})" style="color:var(--red)">Delete</button>
    </td>
  </tr>`).join('');
}

async function toggleBan(id, ban) {
  await api(`/admin/api/users/${id}/ban`, 'PUT', { banned: !!ban });
  loadUsers();
}

async function deleteUser(id) {
  if (!confirm('This user will be deleted. Continue?')) return;
  await api(`/admin/api/users/${id}`, 'DELETE');
  loadUsers();
}

async function loadPool() {
  const d = await api('/admin/api/pool');
  if (!d.success) return;
  document.getElementById('poolBody').innerHTML = d.data.map(p => `<tr>
    <td>${esc(p.username||p.userId)}</td>
    <td>${esc(p.videoId||'-')}</td>
    <td><span class="badge-sm ${p.mode==='auto'?'badge-active':'badge-inactive'}">${p.mode||'?'}</span></td>
    <td>${p.totalMessages||0}</td>
    <td style="font-size:.78rem">${p.startedAt?new Date(p.startedAt).toLocaleString():'-'}</td>
    <td><span class="badge-sm ${p.isRunning?'badge-active':'badge-inactive'}">${p.isRunning?'Running':'Stopped'}</span></td>
  </tr>`).join('');
}

async function loadActivity() {
  const d = await api('/admin/api/activity');
  if (!d.success) return;
  document.getElementById('actLog').innerHTML = d.data.map(a => `<div class="act-item">
    <span class="act-time">${new Date(a.created_at).toLocaleString()}</span>
    <span class="act-action">${esc(a.action)}</span>
    <span class="act-detail">${esc(a.details||'')}</span>
  </div>`).join('');
}

loadDashboard();
</script>
</body>
</html>
