<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strevio Overlay</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: transparent !important; overflow: hidden; width: 100%; height: 100%; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    body { 
      font-family: 'Inter', 'Segoe UI', sans-serif; 
      color: #fff; 
      -webkit-font-smoothing: antialiased;
    }

    :root {
      /* Daha yumuÅŸak ve okunaklÄ± yayÄ±ncÄ± font gÃ¶lgesi */
      --txt-outline:
        -1px -1px 0 rgba(0,0,0,0.8), 
         1px -1px 0 rgba(0,0,0,0.8), 
        -1px  1px 0 rgba(0,0,0,0.8), 
         1px  1px 0 rgba(0,0,0,0.8),
         0px  2px 4px rgba(0,0,0,0.6);
    }

    /* Durum ve Bekleme GÃ¶stergeleri */
    #status {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      font-size: 11px; padding: 6px 16px; border-radius: 99px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      opacity: .9; z-index: 1000; display: flex; align-items: center; gap: 8px;
      transition: all .4s ease; font-weight: 600; color: #fff;
      border: 1px solid rgba(255,255,255,0.1);
    }
    #status .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4757; box-shadow: 0 0 8px #ff4757; }
    #status.connected .dot { background: #00D68F; box-shadow: 0 0 8px #00D68F; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: .5; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

    #waiting {
      position: fixed; bottom: 24px; left: 24px;
      font-size: 13px; padding: 10px 18px;
      background: rgba(15, 15, 20, 0.6); backdrop-filter: blur(10px);
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      opacity: 1; display: flex; align-items: center; gap: 10px;
      color: #e2e8f0; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #waiting .spinner {
      width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.2);
      border-top-color: #6C63FF; border-radius: 50%;
      animation: spin .8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Chat Konteyner */
    #chat {
      position: fixed; bottom: 0; left: 0; width: 100%; padding: 0 20px 20px;
      display: flex; flex-direction: column; justify-content: flex-end;
      max-height: 100vh; overflow: hidden;
      perspective: 1000px;
    }
    #chat.top-left { top: 0; bottom: auto; justify-content: flex-start; }
    #chat.top-right { top: 0; bottom: auto; right: 0; left: auto; justify-content: flex-start; }
    #chat.bottom-right { bottom: 0; right: 0; left: auto; }
    #chat.bottom-left { bottom: 0; left: 0; }

    /* Mesaj TasarÄ±mlarÄ± */
    .msg {
      display: flex; align-items: flex-start; gap: 10px; padding: 4px 8px;
      margin-bottom: 6px;
      background: transparent !important;
      animation: slideIn .4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; /* Spring efekti */
      max-width: 600px;
      transform-origin: left bottom;
      transition: opacity .5s ease, transform .5s ease;
    }
    .msg.fading { opacity: 0; transform: scale(0.9) translateY(10px); }

    .msg-avatar {
      width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; margin-top: 2px;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(0,0,0,0.5);
      object-fit: cover;
    }
    
    .msg-content { display: flex; flex-wrap: wrap; align-items: baseline; gap: 5px; }

    .msg-author {
      font-weight: 800; font-size: 14px; white-space: nowrap;
      color: #C9A0FF; text-shadow: var(--txt-outline); letter-spacing: 0.2px;
    }
    .msg-author.owner  { color: #FFD93D; }
    .msg-author.moderator { color: #6EB5FF; }
    .msg-author.member { color: #2BFFA8; }

    .msg-text {
      font-size: 14px; line-height: 1.5; color: #FFFFFF; word-break: break-word;
      font-weight: 600; text-shadow: var(--txt-outline);
    }
    
    .msg-time {
      font-size: 11px; color: #94a3b8; margin-left: auto; white-space: nowrap; padding-top: 2px;
      text-shadow: var(--txt-outline); font-weight: 500;
    }

    /* Ã–zel Mesaj TÃ¼rleri (Superchat & Member) */
    .msg.superchat .msg-author { color: #FFD93D; }
    .sc-amount {
      font-size: 12px; font-weight: 800; color: #FFD93D;
      background: rgba(255, 217, 61, 0.2); padding: 2px 6px; border-radius: 4px;
      border: 1px solid rgba(255, 217, 61, 0.4);
      margin-right: 4px; text-shadow: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .msg.membership .msg-author { color: #2BFFA8; }
    .mem-badge {
      font-size: 12px; font-weight: 800; color: #2BFFA8;
      background: rgba(43, 255, 168, 0.2); padding: 2px 6px; border-radius: 4px;
      border: 1px solid rgba(43, 255, 168, 0.4);
      margin-right: 4px; text-shadow: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    @keyframes slideIn { 
      0% { opacity: 0; transform: translateX(-20px) scale(0.95); } 
      100% { opacity: 1; transform: translateX(0) scale(1); } 
    }
  </style>
  <style id="customStyle"></style>
</head>
<body>

<div id="status"><span class="dot"></span><span id="statusText">Connecting...</span></div>
<div id="waiting"><div class="spinner"></div> Stream bekleniyor...</div>
<div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function () {
  const pathParts = location.pathname.split('/');
  const overlayToken = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
  if (!overlayToken || overlayToken === 'overlay') {
    document.getElementById('statusText').textContent = 'Token bulunamadÄ±';
    return;
  }

  let settings = {
    theme: 'default', font_size: 14, max_messages: 50, fade_time: 60,
    bg_opacity: 0.45, position: 'bottom-left', show_avatars: true,
    show_badges: true, show_timestamps: false, custom_css: ''
  };

  const chatEl = document.getElementById('chat');
  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const waitingEl = document.getElementById('waiting');

  function applySettings(s) {
    settings = { ...settings, ...s };
    document.body.style.fontSize = settings.font_size + 'px';
    chatEl.className = settings.position || 'bottom-left';

    let styleEl = document.getElementById('customStyle');
    if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = 'customStyle'; document.head.appendChild(styleEl); }
    styleEl.textContent = settings.custom_css || '';
  }

  const socket = io('/overlay', { query: { token: overlayToken } });

  fetch(`/overlay/${overlayToken}/settings`)
    .then(r => r.json())
    .then(d => { if (d.success) applySettings(d.data); })
    .catch(() => {});

  socket.on('connect', () => {
    statusEl.classList.add('connected');
    statusText.textContent = 'BaÄŸlandÄ±';
    setTimeout(() => { statusEl.style.opacity = '0'; }, 3000);
  });

  socket.on('disconnect', () => {
    statusEl.classList.remove('connected');
    statusEl.style.opacity = '1';
    statusText.textContent = 'BaÄŸlantÄ± Koptu';
  });

  socket.on('overlay:settings', applySettings);
  socket.on('chat:message', addMessage);
  socket.on('chat:history', (messages) => { messages.forEach(addMessage); });

  socket.on('chat:status', (data) => {
    waitingEl.style.display = data.running ? 'none' : 'flex';
  });

  function addMessage(msg) {
    waitingEl.style.display = 'none';
    const el = document.createElement('div');
    let cls = 'msg';
    if (msg.type === 'superchat') cls += ' superchat';
    if (msg.type === 'membership') cls += ' membership';
    el.className = cls;

    let html = '';
    if (settings.show_avatars && msg.author?.thumbnail) {
      html += `<img class="msg-avatar" src="${msg.author.thumbnail}" alt="" onerror="this.style.display='none'" />`;
    }
    
    html += '<div class="msg-content">';

    if (msg.type === 'superchat' && msg.superchat) {
      html += `<span class="sc-amount">ðŸ’° ${esc(msg.superchat.amount)}</span>`;
    }
    if (msg.type === 'membership') {
      html += `<span class="mem-badge">ðŸŽ‰ Ãœye</span>`;
    }

    const aCls = msg.author?.badge?.type || 'normal';
    html += `<span class="msg-author ${aCls}">${esc(msg.author?.name || '?')}</span>`;
    html += `<span class="msg-text">${msg.message || ''}</span>`;

    if (settings.show_timestamps && msg.timestamp) {
      const t = new Date(msg.timestamp);
      html += `<span class="msg-time">${t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
    }
    html += '</div>';
    el.innerHTML = html;

    chatEl.appendChild(el);

    while (chatEl.children.length > settings.max_messages) {
      chatEl.firstChild?.remove();
    }

    chatEl.scrollTop = chatEl.scrollHeight;

    if (settings.fade_time > 0) {
      setTimeout(() => {
        el.classList.add('fading');
        setTimeout(() => el.remove(), 500);
      }, settings.fade_time * 1000);
    }
  }

  function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
})();
</script>
</body>
</html>